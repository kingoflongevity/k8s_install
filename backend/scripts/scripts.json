{
  "almalinux_安装kubernetes组件": "# 安装Kubernetes组件\nsudo dnf install -y kubelet${version} kubeadm${version} kubectl${version} --disableexcludes=kubernetes\n\n# 启动kubelet\nsudo systemctl enable --now kubelet",
  "almalinux_安装容器运行时": "# 安装containerd\nsudo dnf install -y containerd.io\n\n# 配置containerd\nsudo mkdir -p /etc/containerd\nsudo containerd config default \u003e /etc/containerd/config.toml\nsudo sed -i 's/SystemdCgroup = false/SystemdCgroup = true/g' /etc/containerd/config.toml\n\n# 启动containerd\nsudo systemctl daemon-reload\nsudo systemctl restart containerd\nsudo systemctl enable containerd",
  "almalinux_添加kubernetes仓库": "# 添加Kubernetes仓库\n# 清理旧的Kubernetes仓库配置\nsudo rm -f /etc/yum.repos.d/kubernetes.repo\nsudo rm -f /etc/yum.repos.d/packages.cloud.google.com_yum_repos_kubernetes-el7-x86_64.repo\n\n# 添加新的Kubernetes仓库\nsudo cat \u003c\u003cEOF \u003e /etc/yum.repos.d/kubernetes.repo\n[kubernetes]\nname=Kubernetes\nbaseurl=https://pkgs.k8s.io/core:/stable:/v1.28/rpm/\nenabled=1\ngpgcheck=1\ngpgkey=https://pkgs.k8s.io/core:/stable:/v1.28/rpm/repodata/repomd.xml.key\nexclude=kubelet kubeadm kubectl\nEOF\n\n# 更新仓库缓存\nsudo dnf makecache",
  "almalinux_系统准备": "# 禁用swap\nsudo swapoff -a\nsudo sed -i '/ swap / s/^#//' /etc/fstab\n\n# 安装并启动时间同步服务\nsudo dnf install -y chrony\nsudo systemctl enable --now chronyd\nsudo timedatectl set-timezone Asia/Shanghai\n\n# 关闭防火墙\nsudo systemctl stop firewalld || true\nsudo systemctl disable firewalld || true\n\n# 禁用SELinux\nsudo setenforce 0\nsudo sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config\n\n# 加载K8s所需内核模块\ncat \u003c\u003cEOF \u003e /etc/modules-load.d/k8s.conf\noverlay\nbr_netfilter\nEOF\nsudo modprobe overlay\nsudo modprobe br_netfilter\n\n# 设置内核参数\n# 使用EOF方式写入IP转发配置文件\ncat \u003c\u003cEOF \u003e /etc/sysctl.d/99-kubernetes-ipforward.conf\nnet.ipv4.ip_forward = 1\nEOF\n\n# 设置其他Kubernetes所需内核参数\ncat \u003c\u003cEOF \u003e /etc/sysctl.d/k8s.conf\nnet.bridge.bridge-nf-call-iptables = 1\nnet.bridge.bridge-nf-call-ip6tables = 1\nEOF\n\n# 应用内核参数\nsudo sysctl --system",
  "centos_安装kubernetes组件": "# 安装Kubernetes组件\nsudo yum install -y kubelet${version} kubeadm${version} kubectl${version} --disableexcludes=kubernetes\n\n# 启动kubelet\nsudo systemctl enable --now kubelet",
  "centos_安装容器运行时": "# 安装containerd\nsudo yum install -y containerd.io\n\n# 配置containerd\nsudo mkdir -p /etc/containerd\nsudo containerd config default \u003e /etc/containerd/config.toml\nsudo sed -i 's/SystemdCgroup = false/SystemdCgroup = true/g' /etc/containerd/config.toml\n\n# 启动containerd\nsudo systemctl daemon-reload\nsudo systemctl restart containerd\nsudo systemctl enable containerd",
  "centos_添加kubernetes仓库": "# 添加Kubernetes仓库\n# 清理旧的Kubernetes仓库配置\nsudo rm -f /etc/yum.repos.d/kubernetes.repo\nsudo rm -f /etc/yum.repos.d/packages.cloud.google.com_yum_repos_kubernetes-el7-x86_64.repo\n\n# 添加新的Kubernetes仓库\nsudo cat \u003c\u003cEOF \u003e /etc/yum.repos.d/kubernetes.repo\n[kubernetes]\nname=Kubernetes\nbaseurl=https://pkgs.k8s.io/core:/stable:/v1.28/rpm/\nenabled=1\ngpgcheck=1\ngpgkey=https://pkgs.k8s.io/core:/stable:/v1.28/rpm/repodata/repomd.xml.key\nexclude=kubelet kubeadm kubectl\nEOF\n\n# 更新仓库缓存\nsudo yum makecache",
  "centos_系统准备": "# 禁用swap\nsudo swapoff -a\nsudo sed -i '/ swap / s/^#//' /etc/fstab\n\n# 安装并启动时间同步服务\nsudo yum install -y chrony\nsudo systemctl enable --now chronyd\nsudo timedatectl set-timezone Asia/Shanghai\n\n# 关闭防火墙\nsudo systemctl stop firewalld || true\nsudo systemctl disable firewalld || true\n\n# 禁用SELinux\nsudo setenforce 0\nsudo sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config\n\n# 加载K8s所需内核模块\ncat \u003c\u003cEOF \u003e /etc/modules-load.d/k8s.conf\noverlay\nbr_netfilter\nEOF\nsudo modprobe overlay\nsudo modprobe br_netfilter\n\n# 设置内核参数\n# 使用EOF方式写入IP转发配置文件\ncat \u003c\u003cEOF \u003e /etc/sysctl.d/99-kubernetes-ipforward.conf\nnet.ipv4.ip_forward = 1\nEOF\n\n# 设置其他Kubernetes所需内核参数\ncat \u003c\u003cEOF \u003e /etc/sysctl.d/k8s.conf\nnet.bridge.bridge-nf-call-iptables = 1\nnet.bridge.bridge-nf-call-ip6tables = 1\nEOF\n\n# 应用内核参数\nsudo sysctl --system",
  "containerd_config": "# containerd配置脚本\necho \"=== 配置并启动containerd ===\"\n# 确保containerd配置目录存在\nmkdir -p /etc/containerd\n\n# 生成默认配置，覆盖现有配置以确保正确性\necho \"生成containerd默认配置...\"\ncontainerd config default | tee /etc/containerd/config.toml\n\n# 确保使用systemd cgroup驱动\nsed -i 's/SystemdCgroup = false/SystemdCgroup = true/g' /etc/containerd/config.toml\n\n# 启动前先停止可能运行的containerd进程\necho \"停止可能运行的containerd进程...\"\npkill -f containerd || true\nsleep 2\n\n# 清理旧的containerd socket和状态文件\necho \"清理旧的containerd socket和状态文件...\"\nrm -f /run/containerd/containerd.sock\nrm -rf /var/run/containerd\nmkdir -p /var/run/containerd\n\n# 启动并启用containerd服务\necho \"启动containerd服务...\"\nsystemctl daemon-reload\nsystemctl restart containerd\nsystemctl enable containerd\n\n# 等待containerd启动，增加等待时间\necho \"等待containerd启动...\"\nsleep 10\n\n# 检查containerd状态\necho \"=== 检查containerd状态 ===\"\nif command -v systemctl \u0026\u003e /dev/null; then\n    systemctl_status=$(systemctl is-active containerd)\n    echo \"containerd服务状态: $systemctl_status\"\n    \n    # 显示containerd服务详细状态\n    echo \"containerd服务详细状态:\"\n    systemctl status containerd --no-pager\nfi\n\n# 检查containerd socket是否存在\necho \"=== 检查containerd socket ===\"\ncri_socket=\"/run/containerd/containerd.sock\"\nif [ -S \"$cri_socket\" ]; then\n    echo \"CRI socket $cri_socket 存在\"\n    # 测试socket连接\n    echo \"测试containerd连接...\"\n    if command -v ctr \u0026\u003e /dev/null; then\n        ctr version\n    fi\nelse\n    echo \"警告: CRI socket $cri_socket 不存在，检查containerd日志...\"\n    journalctl -u containerd --no-pager -n 30\n    \n    # 尝试手动启动containerd\n    echo \"尝试手动启动containerd...\"\n    containerd --version\n    containerd \u0026\n    sleep 5\n    \n    # 再次检查socket\n    if [ -S \"$cri_socket\" ]; then\n        echo \"手动启动成功，CRI socket $cri_socket 现在存在\"\n    else\n        echo \"手动启动失败，CRI socket $cri_socket 仍然不存在\"\n    fi\nfi",
  "containerd_install": "# containerd安装脚本\necho \"=== 安装containerd ===\"\nif ! command -v containerd \u0026\u003e /dev/null; then\n    echo \"containerd未安装，正在安装...\"\n    if command -v apt-get \u0026\u003e /dev/null; then\n        # Ubuntu/Debian系统\n        echo \"=== 使用apt-get安装containerd ===\"\n        apt update -y\n        apt install -y containerd\n    elif command -v dnf \u0026\u003e /dev/null; then\n        # CentOS/RHEL 8+系统\n        echo \"=== 使用dnf安装containerd ===\"\n        dnf install -y containerd\n    elif command -v yum \u0026\u003e /dev/null; then\n        # CentOS/RHEL 7系统\n        echo \"=== 使用yum安装containerd ===\"\n        yum install -y containerd\n    else\n        echo \"=== 警告: 不支持的包管理器，尝试手动安装containerd ===\"\n        # 尝试从GitHub下载并安装containerd\n        if command -v curl \u0026\u003e /dev/null \u0026\u0026 command -v tar \u0026\u003e /dev/null; then\n            CONTAINERD_VERSION=\"1.6.28\"\n            ARCH=\"amd64\"\n            echo \"从GitHub下载containerd v${CONTAINERD_VERSION}...\"\n            curl -L https://github.com/containerd/containerd/releases/download/v${CONTAINERD_VERSION}/containerd-${CONTAINERD_VERSION}-linux-${ARCH}.tar.gz -o /tmp/containerd.tar.gz\n            mkdir -p /usr/local/bin /usr/local/lib /etc/containerd\n            tar Cxzvf /usr/local /tmp/containerd.tar.gz\n            # 创建systemd服务文件\n            cat \u003e /etc/systemd/system/containerd.service \u003c\u003c-'EOF'\n[Unit]\nDescription=containerd container runtime\nDocumentation=https://containerd.io\nAfter=network.target local-fs.target\n\n[Service]\nExecStartPre=-/sbin/modprobe overlay\nExecStart=/usr/local/bin/containerd\nRestart=always\nRestartSec=5\nDelegate=yes\nKillMode=process\nOOMScoreAdjust=-999\nLimitNOFILE=1048576\nLimitNPROC=infinity\nLimitCORE=infinity\n\n[Install]\nWantedBy=multi-user.target\nEOF\n            systemctl daemon-reload\n            systemctl enable containerd\n        fi\n    fi\nfi",
  "debian_安装kubernetes组件": "# 安装Kubernetes组件\nsudo apt install -y kubelet${version} kubeadm${version} kubectl${version}\n\n# 启动kubelet\nsudo systemctl enable --now kubelet",
  "debian_安装容器运行时": "# 安装containerd\nsudo apt update\nsudo apt install -y containerd.io\n\n# 配置containerd\nsudo mkdir -p /etc/containerd\nsudo containerd config default \u003e /etc/containerd/config.toml\nsudo sed -i 's/SystemdCgroup = false/SystemdCgroup = true/g' /etc/containerd/config.toml\n\n# 启动containerd\nsudo systemctl daemon-reload\nsudo systemctl restart containerd\nsudo systemctl enable containerd",
  "debian_添加kubernetes仓库": "# 添加Kubernetes仓库\nsudo apt update\nsudo apt install -y apt-transport-https ca-certificates curl gpg\n\n# 创建keyring目录\nsudo mkdir -p -m 755 /etc/apt/keyrings\n\n# 下载并安装GPG密钥\ncurl -fsSL -L https://pkgs.k8s.io/core:/stable:/v1.28/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg\n\n# 添加Kubernetes repo\necho \"deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.28/deb/ /\" | sudo tee /etc/apt/sources.list.d/kubernetes.list\n\n# 更新仓库缓存\nsudo apt update",
  "debian_系统准备": "# 禁用swap\nsudo swapoff -a\nsudo sed -i '/ swap / s/^#//' /etc/fstab\n\n# 安装并启动时间同步服务\nsudo apt update\nsudo apt install -y chrony\nsudo systemctl enable --now chronyd\nsudo timedatectl set-timezone Asia/Shanghai\n\n# 关闭防火墙\nsudo systemctl stop ufw || true\nsudo systemctl disable ufw || true\n\n# 加载K8s所需内核模块\ncat \u003c\u003cEOF \u003e /etc/modules-load.d/k8s.conf\noverlay\nbr_netfilter\nEOF\nsudo modprobe overlay\nsudo modprobe br_netfilter\n\n# 设置内核参数\n# 使用EOF方式写入IP转发配置文件\ncat \u003c\u003cEOF \u003e /etc/sysctl.d/99-kubernetes-ipforward.conf\nnet.ipv4.ip_forward = 1\nEOF\n\n# 设置其他Kubernetes所需内核参数\ncat \u003c\u003cEOF \u003e /etc/sysctl.d/k8s.conf\nnet.bridge.bridge-nf-call-iptables = 1\nnet.bridge.bridge-nf-call-ip6tables = 1\nEOF\n\n# 应用内核参数\nsudo sysctl --system",
  "k8s_components": "# Kubernetes组件安装脚本\necho \"=== 安装Kubernetes组件 ===\"\n# 确保所有命令都使用sudo权限\nif command -v apt-get \u0026\u003e /dev/null; then\n    # Ubuntu/Debian系统\n    sudo apt-get update -y\n    sudo apt-get install -y kubelet kubeadm kubectl\n    sudo systemctl enable --now kubelet\nelif command -v dnf \u0026\u003e /dev/null; then\n    # CentOS/RHEL 8+系统\n    sudo dnf install -y kubelet kubeadm kubectl --disableexcludes=kubernetes\n    sudo systemctl enable --now kubelet\nelif command -v yum \u0026\u003e /dev/null; then\n    # CentOS/RHEL 7系统\n    sudo yum install -y kubelet kubeadm kubectl --disableexcludes=kubernetes\n    sudo systemctl enable --now kubelet\nfi",
  "rocky_安装kubernetes组件": "# 安装Kubernetes组件\nsudo dnf install -y kubelet${version} kubeadm${version} kubectl${version} --disableexcludes=kubernetes\n\n# 启动kubelet\nsudo systemctl enable --now kubelet",
  "rocky_安装容器运行时": "# 安装containerd\nsudo dnf install -y containerd.io\n\n# 配置containerd\nsudo mkdir -p /etc/containerd\nsudo containerd config default \u003e /etc/containerd/config.toml\nsudo sed -i 's/SystemdCgroup = false/SystemdCgroup = true/g' /etc/containerd/config.toml\n\n# 启动containerd\nsudo systemctl daemon-reload\nsudo systemctl restart containerd\nsudo systemctl enable containerd",
  "rocky_添加kubernetes仓库": "# 添加Kubernetes仓库\n# 清理旧的Kubernetes仓库配置\nsudo rm -f /etc/yum.repos.d/kubernetes.repo\nsudo rm -f /etc/yum.repos.d/packages.cloud.google.com_yum_repos_kubernetes-el7-x86_64.repo\n\n# 添加新的Kubernetes仓库\nsudo cat \u003c\u003cEOF \u003e /etc/yum.repos.d/kubernetes.repo\n[kubernetes]\nname=Kubernetes\nbaseurl=https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.28/rpm/\nenabled=1\ngpgcheck=1\ngpgkey=https://mirrors.aliyun.com/kubernetes-new/core/stable/v1.28/rpm/repodata/repomd.xml.key\nexclude=kubelet kubeadm kubectl\nEOF\n\n# 更新仓库缓存\nsudo dnf makecache",
  "rocky_系统准备": "# 禁用swap\nsudo swapoff -a\nsudo sed -i '/ swap / s/^#//' /etc/fstab\n\n# 安装并启动时间同步服务\nsudo dnf install -y chrony\nsudo systemctl enable --now chronyd\nsudo timedatectl set-timezone Asia/Shanghai\n\n# 关闭防火墙\nsudo systemctl stop firewalld || true\nsudo systemctl disable firewalld || true\n\n# 禁用SELinux\nsudo setenforce 0\nsudo sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config\n\n# 加载K8s所需内核模块\ncat \u003c\u003cEOF \u003e /etc/modules-load.d/k8s.conf\noverlay\nbr_netfilter\nEOF\nsudo modprobe overlay\nsudo modprobe br_netfilter\n\n# 设置内核参数\n# 使用EOF方式写入IP转发配置文件\ncat \u003c\u003cEOF \u003e /etc/sysctl.d/99-kubernetes-ipforward.conf\nnet.ipv4.ip_forward = 1\nEOF\n\n# 设置其他Kubernetes所需内核参数\ncat \u003c\u003cEOF \u003e /etc/sysctl.d/k8s.conf\nnet.bridge.bridge-nf-call-iptables = 1\nnet.bridge.bridge-nf-call-ip6tables = 1\nEOF\n\n# 应用内核参数\nsudo sysctl --system",
  "system_prep": "# 系统准备脚本\n# 禁用swap\nswapoff -a\nsed -i '/ swap / s/^#/' /etc/fstab\n\n# 安装并启动时间同步服务\necho \"=== 安装并配置时间同步 ===\"\nif command -v apt-get \u0026\u003e /dev/null; then\n    apt update -y\n    apt install -y chrony\n    systemctl enable --now chronyd || systemctl enable --now chrony\n    timedatectl set-timezone Asia/Shanghai\n    systemctl restart chronyd || systemctl restart chrony\n    chronyc sources\nelif command -v dnf \u0026\u003e /dev/null || command -v yum \u0026\u003e /dev/null; then\n    if command -v dnf \u0026\u003e /dev/null; then\n        dnf install -y chrony\n    else\n        yum install -y chrony\n    fi\n    systemctl enable --now chronyd\n    timedatectl set-timezone Asia/Shanghai\n    systemctl restart chronyd || systemctl restart chrony\n    chronyc sources\nfi\n\n# 关闭防火墙（实验环境建议关闭）\necho \"=== 配置防火墙 ===\"\nif command -v ufw \u0026\u003e /dev/null; then\n    systemctl stop ufw || true\n    systemctl disable ufw || true\nelif command -v firewall-cmd \u0026\u003e /dev/null; then\n    systemctl stop firewalld || true\n    systemctl disable firewalld || true\nfi\n\n# 禁用SELINUX（仅适用于RHEL/CentOS系统）\necho \"=== 配置SELinux ===\"\nif command -v setenforce \u0026\u003e /dev/null; then\n    setenforce 0 2\u003e/dev/null || true\n    sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config 2\u003e/dev/null || true\nfi\n\n# 加载K8s所需内核模块\necho \"=== 加载Kubernetes所需内核模块 ===\"\nsudo cat \u003c\u003cEOF \u003e /etc/modules-load.d/k8s.conf\noverlay\nbr_netfilter\nEOF\nsudo modprobe overlay\nsudo modprobe br_netfilter\n\n# 设置内核参数\necho \"=== 设置内核参数 ===\"\n# 使用EOF方式写入IP转发配置文件\nsudo cat \u003c\u003cEOF \u003e /etc/sysctl.d/99-kubernetes-ipforward.conf\nnet.ipv4.ip_forward = 1\nEOF\n\n# 设置其他Kubernetes所需内核参数\nsudo cat \u003c\u003cEOF \u003e /etc/sysctl.d/k8s.conf\nnet.bridge.bridge-nf-call-iptables = 1\nnet.bridge.bridge-nf-call-ip6tables = 1\nEOF\n\nsudo sysctl --system\n\n# 验证内核参数设置\necho \"=== 验证内核参数 ===\"\nsysctl net.bridge.bridge-nf-call-iptables net.bridge.bridge-nf-call-ip6tables net.ipv4.ip_forward",
  "ubuntu_安装kubernetes组件": "# 安装Kubernetes组件\nsudo apt install -y kubelet${version} kubeadm${version} kubectl${version}\n\n# 启动kubelet\nsudo systemctl enable --now kubelet",
  "ubuntu_安装容器运行时": "# 安装containerd\nsudo apt update\nsudo apt install -y containerd.io\n\n# 配置containerd\nsudo mkdir -p /etc/containerd\nsudo containerd config default \u003e /etc/containerd/config.toml\nsudo sed -i 's/SystemdCgroup = false/SystemdCgroup = true/g' /etc/containerd/config.toml\n\n# 启动containerd\nsudo systemctl daemon-reload\nsudo systemctl restart containerd\nsudo systemctl enable containerd",
  "ubuntu_添加kubernetes仓库": "# 添加Kubernetes仓库\nsudo apt update\nsudo apt install -y apt-transport-https ca-certificates curl gpg\n\n# 创建keyring目录\nsudo mkdir -p -m 755 /etc/apt/keyrings\n\n# 下载并安装GPG密钥\ncurl -fsSL -L https://pkgs.k8s.io/core:/stable:/v1.28/deb/Release.key | sudo gpg --dearmor -o /etc/apt/keyrings/kubernetes-apt-keyring.gpg\n\n# 添加Kubernetes repo\necho \"deb [signed-by=/etc/apt/keyrings/kubernetes-apt-keyring.gpg] https://pkgs.k8s.io/core:/stable:/v1.28/deb/ /\" | sudo tee /etc/apt/sources.list.d/kubernetes.list\n\n# 更新仓库缓存\nsudo apt update",
  "ubuntu_系统准备": "# 禁用swap\nsudo swapoff -a\nsudo sed -i '/ swap / s/^#//' /etc/fstab\n\n# 安装并启动时间同步服务\nsudo apt update\nsudo apt install -y chrony\nsudo systemctl enable --now chronyd\nsudo timedatectl set-timezone Asia/Shanghai\n\n# 关闭防火墙\nsudo systemctl stop ufw || true\nsudo systemctl disable ufw || true\n\n# 加载K8s所需内核模块\ncat \u003c\u003cEOF \u003e /etc/modules-load.d/k8s.conf\noverlay\nbr_netfilter\nEOF\nsudo modprobe overlay\nsudo modprobe br_netfilter\n\n# 设置内核参数\n# 使用EOF方式写入IP转发配置文件\ncat \u003c\u003cEOF \u003e /etc/sysctl.d/99-kubernetes-ipforward.conf\nnet.ipv4.ip_forward = 1\nEOF\n\n# 设置其他Kubernetes所需内核参数\ncat \u003c\u003cEOF \u003e /etc/sysctl.d/k8s.conf\nnet.bridge.bridge-nf-call-iptables = 1\nnet.bridge.bridge-nf-call-ip6tables = 1\nEOF\n\n# 应用内核参数\nsudo sysctl --system"
}